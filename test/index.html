<!DOCTYPE html>
<html>
    <head>
        <title></title>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <link rel="stylesheet" href="//code.jquery.com/qunit/qunit-1.11.0.css">
        <link rel="stylesheet" href="//code.jquery.com/ui/1.10.2/themes/smoothness/jquery-ui.css">
    </head>
    <body>
        <div id="qunit"></div>
        <div id="qunit-fixture"></div>
        <input id="geoname-id" value="" />
        <script src="//code.jquery.com/jquery-1.9.1.min.js"></script>
        <script src="//code.jquery.com/ui/1.10.2/jquery-ui.js"></script>
        <script src="//code.jquery.com/qunit/qunit-1.11.0.js"></script>
        <script type="text/javascript" src="../jquery.geonames.js"></script>

        <script>
            var completer;
            var $input;
            var geonameId = $("#geoname-id");

            QUnit.config.reorder = false;
            QUnit.config.autostart = false;

            QUnit.start();

            QUnit.testStart(function() {
                completer = geonameId.geocompleter({
                    "server": "http://geonames-server.tld/"
                });

                $input = $(".ui-autocomplete-input");

                completer.geocompleter("autocompleter", "option", "source", function(request, response) {
                    var data = {
                        "geonames": {
                            "totalResultsCount": "30",
                            "geoname": [
                                {
                                    "geonameid": "2988507",
                                    "title": "Paris",
                                    "country": "France",
                                    "match": {
                                        "title": "Paris",
                                        "country": "France"
                                    },
                                    "population": "2138551",
                                    "location": {
                                        "latitude": "48.81",
                                        "longitude": "2.38"
                                    },
                                    "region": "Île-de-France",
                                    "title_alt": "Paris"
                                },
                                {
                                    "geonameid": "4717560",
                                    "title": "Paris",
                                    "country": "United States",
                                    "match": {
                                        "title": "Paris",
                                        "country": "United States"
                                    },
                                    "population": "25171",
                                    "location": {
                                        "latitude": "33.94",
                                        "longitude": "-95.55"
                                    },
                                    "region": "Texas",
                                    "title_alt": "Paris"
                                },
                                {
                                    "geonameid": "6942553",
                                    "title": "Paris",
                                    "country": "Canada",
                                    "match": {
                                        "title": "Paris",
                                        "country": "Canada"
                                    },
                                    "population": "11177",
                                    "location": {
                                        "latitude": "43.2",
                                        "longitude": "-80.38"
                                    },
                                    "region": "Ontario",
                                    "title_alt": "Paris"
                                },
                                {
                                    "geonameid": "4647963",
                                    "title": "Paris",
                                    "country": "United States",
                                    "match": {
                                        "title": "Paris",
                                        "country": "United States"
                                    },
                                    "population": "10156",
                                    "location": {
                                        "latitude": "36.3",
                                        "longitude": "-88.32"
                                    },
                                    "region": "Tennessee",
                                    "title_alt": "Paris"
                                },
                                {
                                    "geonameid": "4246659",
                                    "title": "Paris",
                                    "country": "United States",
                                    "match": {
                                        "title": "Paris",
                                        "country": "United States"
                                    },
                                    "population": "8837",
                                    "location": {
                                        "latitude": "39.61",
                                        "longitude": "-87.69"
                                    },
                                    "region": "Illinois",
                                    "title_alt": "Paris"
                                },
                                {
                                    "geonameid": "4303602",
                                    "title": "Paris",
                                    "country": "United States",
                                    "match": {
                                        "title": "Paris",
                                        "country": "United States"
                                    },
                                    "population": "8553",
                                    "location": {
                                        "latitude": "38.2",
                                        "longitude": "-84.25"
                                    },
                                    "region": "Kentucky",
                                    "title_alt": "Paris"
                                },
                                {
                                    "geonameid": "4974617",
                                    "title": "Paris",
                                    "country": "United States",
                                    "match": {
                                        "title": "Paris",
                                        "country": "United States"
                                    },
                                    "population": "5073",
                                    "location": {
                                        "latitude": "44.25",
                                        "longitude": "-70.5"
                                    },
                                    "region": "Maine",
                                    "title_alt": "Paris"
                                },
                                {
                                    "geonameid": "4125402",
                                    "title": "Paris",
                                    "country": "United States",
                                    "match": {
                                        "title": "Paris",
                                        "country": "United States"
                                    },
                                    "population": "3532",
                                    "location": {
                                        "latitude": "35.22",
                                        "longitude": "-93.72"
                                    },
                                    "region": "Arkansas",
                                    "title_alt": "Paris"
                                },
                                {
                                    "geonameid": "4402452",
                                    "title": "Paris",
                                    "country": "United States",
                                    "match": {
                                        "title": "Paris",
                                        "country": "United States"
                                    },
                                    "population": "1220",
                                    "location": {
                                        "latitude": "39.48",
                                        "longitude": "-92"
                                    },
                                    "region": "Missouri",
                                    "title_alt": "Paris"
                                },
                                {
                                    "geonameid": "5205082",
                                    "title": "Paris",
                                    "country": "United States",
                                    "match": {
                                        "title": "Paris",
                                        "country": "United States"
                                    },
                                    "population": "732",
                                    "location": {
                                        "latitude": "40.4",
                                        "longitude": "-80.51"
                                    },
                                    "region": "Pennsylvania",
                                    "title_alt": "Paris"
                                },
                                {
                                    "geonameid": "5603240",
                                    "title": "Paris",
                                    "country": "United States",
                                    "match": {
                                        "title": "Paris",
                                        "country": "United States"
                                    },
                                    "population": "513",
                                    "location": {
                                        "latitude": "42.22",
                                        "longitude": "-111.4"
                                    },
                                    "region": "Idaho",
                                    "title_alt": "Paris"
                                },
                                {
                                    "geonameid": "6601248",
                                    "title": "Paris",
                                    "country": "Indonesia",
                                    "match": {
                                        "title": "Paris",
                                        "country": "Indonesia"
                                    },
                                    "population": "0",
                                    "location": {
                                        "latitude": "-6.83",
                                        "longitude": "106.77"
                                    },
                                    "region": "West Java",
                                    "title_alt": "Paris"
                                },
                                {
                                    "geonameid": "3719266",
                                    "title": "Paris",
                                    "country": "Haiti",
                                    "match": {
                                        "title": "Paris",
                                        "country": "Haiti"
                                    },
                                    "population": "0",
                                    "location": {
                                        "latitude": "18.5",
                                        "longitude": "-73.91"
                                    },
                                    "region": "GrandʼAnse",
                                    "title_alt": "Paris"
                                },
                                {
                                    "geonameid": "7753771",
                                    "title": "Paris",
                                    "country": "Indonesia",
                                    "match": {
                                        "title": "Paris",
                                        "country": "Indonesia"
                                    },
                                    "population": "0",
                                    "location": {
                                        "latitude": "-6.93",
                                        "longitude": "106.39"
                                    },
                                    "region": "Banten",
                                    "title_alt": "Paris"
                                },
                                {
                                    "geonameid": "2410936",
                                    "title": "Paris",
                                    "country": "Sao Tome and Principe",
                                    "match": {
                                        "title": "Paris",
                                        "country": "Sao Tome and Principe"
                                    },
                                    "population": "0",
                                    "location": {
                                        "latitude": "0.33",
                                        "longitude": "6.68"
                                    },
                                    "region": "São Tomé Island",
                                    "title_alt": "Paris"
                                },
                                {
                                    "geonameid": "4590439",
                                    "title": "Paris",
                                    "country": "United States",
                                    "match": {
                                        "title": "Paris",
                                        "country": "United States"
                                    },
                                    "population": "0",
                                    "location": {
                                        "latitude": "34.89",
                                        "longitude": "-82.36"
                                    },
                                    "region": "South Carolina",
                                    "title_alt": "Paris"
                                },
                                {
                                    "geonameid": "2565615",
                                    "title": "Paris",
                                    "country": "Republic of the Congo",
                                    "match": {
                                        "title": "Paris",
                                        "country": "Republic of the Congo"
                                    },
                                    "population": "0",
                                    "location": {
                                        "latitude": "1.55",
                                        "longitude": "15.64"
                                    },
                                    "region": "Sangha",
                                    "title_alt": "Paris"
                                },
                                {
                                    "geonameid": "4566515",
                                    "title": "Paris",
                                    "country": "Puerto Rico",
                                    "match": {
                                        "title": "Paris",
                                        "country": "Puerto Rico"
                                    },
                                    "population": "0",
                                    "location": {
                                        "latitude": "18.2",
                                        "longitude": "-67.13"
                                    },
                                    "title_alt": "Paris"
                                },
                                {
                                    "geonameid": "2255463",
                                    "title": "Paris",
                                    "country": "Republic of the Congo",
                                    "match": {
                                        "title": "Paris",
                                        "country": "Republic of the Congo"
                                    },
                                    "population": "0",
                                    "location": {
                                        "latitude": "-4.26",
                                        "longitude": "14.89"
                                    },
                                    "region": "Pool",
                                    "title_alt": "Paris"
                                },
                                {
                                    "geonameid": "5166095",
                                    "title": "Paris",
                                    "country": "United States",
                                    "match": {
                                        "title": "Paris",
                                        "country": "United States"
                                    },
                                    "population": "0",
                                    "location": {
                                        "latitude": "40.79",
                                        "longitude": "-81.16"
                                    },
                                    "region": "Ohio",
                                    "title_alt": "Paris"
                                },
                                {
                                    "geonameid": "2255462",
                                    "title": "Paris",
                                    "country": "Republic of the Congo",
                                    "match": {
                                        "title": "Paris",
                                        "country": "Republic of the Congo"
                                    },
                                    "population": "0",
                                    "location": {
                                        "latitude": "-4.75",
                                        "longitude": "14.69"
                                    },
                                    "region": "Pool",
                                    "title_alt": "Paris"
                                },
                                {
                                    "geonameid": "5744934",
                                    "title": "Paris",
                                    "country": "United States",
                                    "match": {
                                        "title": "Paris",
                                        "country": "United States"
                                    },
                                    "population": "0",
                                    "location": {
                                        "latitude": "44.25",
                                        "longitude": "-123.77"
                                    },
                                    "region": "Oregon",
                                    "title_alt": "Paris"
                                },
                                {
                                    "geonameid": "2396599",
                                    "title": "Paris",
                                    "country": "Gabon",
                                    "match": {
                                        "title": "Paris",
                                        "country": "Gabon"
                                    },
                                    "population": "0",
                                    "location": {
                                        "latitude": "-0.66",
                                        "longitude": "10.3"
                                    },
                                    "region": "Moyen-Ogooué",
                                    "title_alt": "Paris"
                                },
                                {
                                    "geonameid": "4870696",
                                    "title": "Paris",
                                    "country": "United States",
                                    "match": {
                                        "title": "Paris",
                                        "country": "United States"
                                    },
                                    "population": "0",
                                    "location": {
                                        "latitude": "42.86",
                                        "longitude": "-91.06"
                                    },
                                    "region": "Iowa",
                                    "title_alt": "Paris"
                                },
                                {
                                    "geonameid": "2396598",
                                    "title": "Paris",
                                    "country": "Gabon",
                                    "match": {
                                        "title": "Paris",
                                        "country": "Gabon"
                                    },
                                    "population": "0",
                                    "location": {
                                        "latitude": "-1.3",
                                        "longitude": "12.41"
                                    },
                                    "region": "Ogooué-Lolo",
                                    "title_alt": "Paris"
                                },
                                {
                                    "geonameid": "4870695",
                                    "title": "Paris",
                                    "country": "United States",
                                    "match": {
                                        "title": "Paris",
                                        "country": "United States"
                                    },
                                    "population": "0",
                                    "location": {
                                        "latitude": "40.78",
                                        "longitude": "-92.59"
                                    },
                                    "region": "Iowa",
                                    "title_alt": "Paris"
                                },
                                {
                                    "geonameid": "4262774",
                                    "title": "Paris",
                                    "country": "United States",
                                    "match": {
                                        "title": "Paris",
                                        "country": "United States"
                                    },
                                    "population": "0",
                                    "location": {
                                        "latitude": "38.82",
                                        "longitude": "-85.63"
                                    },
                                    "region": "Indiana",
                                    "title_alt": "Paris"
                                },
                                {
                                    "geonameid": "5090809",
                                    "title": "Paris",
                                    "country": "United States",
                                    "match": {
                                        "title": "Paris",
                                        "country": "United States"
                                    },
                                    "population": "0",
                                    "location": {
                                        "latitude": "44.66",
                                        "longitude": "-71.32"
                                    },
                                    "region": "New Hampshire",
                                    "title_alt": "Paris"
                                },
                                {
                                    "geonameid": "4777909",
                                    "title": "Paris",
                                    "country": "United States",
                                    "match": {
                                        "title": "Paris",
                                        "country": "United States"
                                    },
                                    "population": "0",
                                    "location": {
                                        "latitude": "39",
                                        "longitude": "-77.98"
                                    },
                                    "region": "Virginia",
                                    "title_alt": "Paris"
                                },
                                {
                                    "geonameid": "5130523",
                                    "title": "Paris",
                                    "country": "United States",
                                    "match": {
                                        "title": "Paris",
                                        "country": "United States"
                                    },
                                    "population": "0",
                                    "location": {
                                        "latitude": "43",
                                        "longitude": "-75.31"
                                    },
                                    "region": "New York",
                                    "title_alt": "Paris"
                                }
                            ]
                        }
                    };

                    response($.map(data.geonames.geoname || {}, function(item) {
                        return {
                            label: item.title + (item.country ? ", " + item.country : ''),
                            value: item.title + (item.country ? ", " + item.country : ''),
                            geonameid: item.geonameid
                        };
                    }));
                });

                geonameId.show();
            });

            QUnit.testDone(function() {
                completer.geocompleter('destroy');
            });

            test("item list is empty and no visible", function() {
                ok($('ul.ui-autocomplete li').length === 0);
                ok($('ul.ui-autocomplete').is(':hidden'));
            });

            asyncTest("item list is no more empty and visible when looking for cities", 2, function() {
                $input.focus();
                $input.val('par');
                $input.keydown();
                setTimeout(function() {
                    ok($('ul.ui-autocomplete li').length > 0);
                    ok($('ul.ui-autocomplete').is(':visible'));
                    start();
                }, 500);
            });

            asyncTest('should fill geoname input when I click on item list', function() {
                $input.focus();
                $input.val('par');
                $input.keydown();
                setTimeout(function() {
                    $('ul.ui-autocomplete:first li').first().trigger('click');
                    equal($input.val(), $('ul.ui-autocomplete li:first a').html());
                    equal(geonameId.val(), '2988507');
                    start();
                }, 500);
            });

            asyncTest('should not fill geoname input when loose focus', function() {
                $input.focus();
                $input.val('par');
                $input.keydown();
                setTimeout(function() {
                    $input.blur();
                    equal('', $input.val());
                    equal('', geonameId.val());
                    start();
                }, 500);
            });

            asyncTest('should empty geoname input if value does not match item list', function() {
                $input.focus();
                $input.val('par');
                $input.keydown();
                setTimeout(function() {
                    $('ul.ui-autocomplete li').first().trigger('click');
                    var inputVal = $input.val();
                    $input.val(inputVal.substring(0, inputVal.length - 1));
                    $input.keyup();
                    setTimeout(function(){
                        equal(geonameId.val(),'');
                        start();
                    }, 500);
                }, 500);
            });

            asyncTest('should resynchornize geoname input if value match item list', function() {
                $input.focus();
                $input.val("Paris, France");
                $input.keydown();
                setTimeout(function() {
                    $('ul.ui-autocomplete li').first().trigger('click');
                    setTimeout(function() {
                        $input.val("Paris, Franc");
                        $input.keydown();
                        setTimeout(function(){
                            $input.val("Paris, France");
                            $input.keydown();
                            setTimeout(function(){
                                equal(geonameId.val(), '2988507');
                                start();
                            }, 500);
                        }, 500);
                    }, 500);
                }, 500);
            });
        </script>
    </body>
</html>
